const t=t=>t?t.toString().replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"",e=t=>null==t,n=(t,e)=>{const{ref:n}=e.dataset,i=n.match(/(\w+)\[(.+)\]/);return null!==i?s(t,e,i):{...t,[e.dataset.ref]:e}},s=(t,e,[,n,s])=>(void 0===t[n]&&(t[n]=[]),t[n][s]=e,t);class i extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(t=null){const e=t||this.attributes;let n;try{n=[...e].reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});const t=[...e].find((t=>"data"===t.nodeName));return null==t?n:{...n,...JSON.parse(t.nodeValue)}}catch(t){console.log("ERROR: No data",t)}}render(t=!1){t&&(this.innerHTML="");const e=(t,n)=>{const s=t=>3===t.nodeType?"text":8===t.nodeType?"comment":t.tagName.toLowerCase(),i=t=>t.childNodes&&t.childNodes.length>0?null:t.textContent;var r=Array.prototype.slice.call(n.childNodes),a=Array.prototype.slice.call(t.childNodes),o=r.length-a.length;if(o>0)for(;o>0;o--)r[r.length-o].parentNode.removeChild(r[r.length-o]);a.forEach((function(t,a){if(r[a])if(s(t)===s(r[a])){var o=i(t);if(o&&o!==i(r[a])&&(r[a].textContent=o),r[a].childNodes.length>0&&t.childNodes.length<1)r[a].innerHTML="";else{if(r[a].childNodes.length<1&&t.childNodes.length>0){var l=document.createDocumentFragment();return e(t,l),void r[a].appendChild(l)}t.childNodes.length>0&&e(t,r[a])}}else r[a].parentNode.replaceChild(t.cloneNode(!0),r[a]);else n.appendChild(t.cloneNode(!0))}))},n=(s=this.template,(new DOMParser).parseFromString(s,"text/html").body);var s;e(n,this)}loadTemplate(t="",e=!1){this.template=""===t?this.template:`${t}`,this.render(e)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",i);const r={get is(){const{innerWidth:t,devicePixelRatio:e}=window;return{mobile:t<768,mobile_tablet:t<1024,tablet:t>=768&&t<1024,desktop:t>=1024&&e<=1,retina:t>=1024&&e>1}},lt:t=>window.innerWidth<t},a=t=>window.napi.catalog().getProduct(t);const o=(t="product",e=150)=>{const n=[];return t&&n.push(`impolicy=${t}`),e&&n.push(`imwidth=${e}`),`?${n.join("&")}`};class l extends HTMLElement{constructor(){super(),this.buttonElements=null,this.currentProducts=null,this.currentIndex=null,this.productsCached={},this.boundHandleClick=this.handleClick.bind(this),this.boundSliderScroll=this.onSliderScroll.bind(this),this.boundKeyNavTab=this.keyNavTab.bind(this)}connectedCallback(){this.props=(t=>{const n=(t=>t.find((t=>"data"===t.nodeName)))([...t]),s=[...t].filter((t=>"data"!==t.nodeName)).reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});if(e(n))return s;try{return{...s,...JSON.parse(n.nodeValue)}}catch(t){console.log("ERROR: No data",t)}})(this.attributes),this.render(),this.refs=[...this.querySelectorAll("[data-ref]")].reduce(n,{}),this.initSlider(this.refs.slider),this.bindEvent(),this.onReady().then()}async onReady(){this.priceFormatter=await window.napi.priceFormat(),this.currency=window[window.config.padl.namespace].dataLayer.app.app.currency,this.switchTabs(0)}render(){const{layout:t,campaign:e}=this.props,{contrast_mobile:n,contrast:s}=t,i=r.is.mobile&&""!==n?n:s;this.innerHTML=`\n            <nb-container\n                background_color="${t.background_color}"\n                background_retina="${t.background.retina}"\n                background_desktop="${t.background.desktop}"\n                background_mobile="${t.background.mobile}"\n                campaign_id="${e.id}"\n                campaign_name="${e.name}"\n                campaign_position="${e.position}"\n                campaign_creative="${e.creative}"\n                contrast="${i}"\n                classname="${t.padding_top} ${t.padding_bottom}">\n                <div class="cb-col1">\n                    ${this.renderTitle()}\n                    ${r.is.mobile_tablet?"":this.renderContent()}\n                </div>\n                <div class='cb-col2'>\n                    ${this.renderOneOrMultipleTabs()}\n                    ${r.is.mobile_tablet?this.renderContent():""}\n                </div>\n            </nb-container>\n        `,this.tabs=this.querySelector(".tabs"),this.buttonElements=this.querySelectorAll(".tabs button"),this.panelElements=this.querySelectorAll(".panel")}renderTitle(){const{heading:t}=this.props.copywriting;return t?`<h2 class='h-3xl-300-sl'>${t}</h2>`:""}renderContent(){return`\n            ${this.renderText()}\n            ${this.renderCta()}\n            ${this.renderDisclaimer()}\n        `}renderText(){const{text:t}=this.props.copywriting;if(!t)return"";return`<p class='text ${r.is.mobile?"t-sm-400":"t-md-400-sl"}'>${t}</p>`}renderCta(){const{id:e,name:n,creative:s,position:i}=this.props.campaign,{cta:r={}}=this.props.copywriting,{label:a=""}=r;if(!a)return"";r.campaign_id=e,r.campaign_name=n,r.campaign_creative=s,r.campaign_position=i;return`<nb-cta data="${(e=>t(JSON.stringify(e)))(r)}">${a}</nb-cta>`}renderDisclaimer(){const{disclaimer:t}=this.props.copywriting;return""===t?"":`<small class='t-2xs-500-sl'>${t}</small>`}renderOneOrMultipleTabs(){const{tabs:t=[]}=this.props.copywriting;return 1===t.length?this.renderOnePanel():this.renderTabs()+this.renderPanels()}renderOnePanel(){this.hasTabs=!1;const{tabs:t}=this.props.copywriting;if(!t||!t.length)return"";return`\n            <div class='panels' data-ref='slider' tabindex='-1'>\n                <div class="panel" data-ref="panel-0" products-number="${t[0].products.length}">\n                    <nb-loader></nb-loader>\n                </div>\n            </div>\n        `}renderTabs(){this.hasTabs=!0,this.classList.add("hasSlider");const{a11y_label_tablist:t,tabs:e}=this.props.copywriting;if(!e||!e.length)return"";const n=e.reduce(((t,e,n)=>`${t}${this.renderTab(e,n)}`),"");return`<div class='tabs' role='tablist' aria-label='${t}' tab-number='${e.length}'>${n}</div>`}renderTab({label:t,label_mobile:e,a11y_label:n,icon:s},i){let a=t;return r.is.mobile&&e&&""!==e&&(a=e),`\n            <button\n                data-index="${i}"\n                role="tab"\n                id="hero-product-showcase-tab-${i}"\n                aria-controls="hero-product-showcase-tabpanel-${i}"\n                aria-label="${n}">\n                <nb-icon icon="${s}"></nb-icon>\n                <span class="t-xs-700-caps">\n                    ${a}\n                </span>\n            </button>\n        `}renderPanels(){const{tabs:t}=this.props.copywriting;if(!t||!t.length)return"";return`<div class='panels' data-ref='slider' tabindex='-1'>${t.reduce(((t,e,n)=>`${t}${this.renderPanel(n)}`),"")}</div>`}renderPanel(t){const{tabs:e}=this.props.copywriting;if(!e||!e.length)return"";const n=e[t].products.length;return`\n            <div class="panel"\n                role="tabpanel"\n                data-ref="panel-${t}"\n                id="hero-product-showcase-tabpanel-${t}"\n                aria-label="${e[t].a11y_label}"\n                products-number="${n}">\n                <nb-loader></nb-loader>\n            </div>\n        `}switchTabs(t,e=!1){const{tabs:n}=this.props.copywriting;n&&n.length&&n[t]&&(this.currentProducts=n[t].products,this.currentIndex=t,this.hasTabs&&this.setButtonSelected(),e||this.goSlider(),this.productsCached[this.currentIndex]||(this.productsCached[this.currentIndex]=[],this.loadProducts().then()))}async loadProducts(){try{await function(t){const e=[];if(!window.napi)return Promise.reject();Array.isArray(t)||(t=[t]);for(const n of t)e.push(a(n).then((e=>t.splice(t.indexOf(n),1,e))).catch((()=>{t.splice(t.indexOf(n),1),console.error(`getProduct fail on sku ${n}`)})));return Promise.all(e)}(this.currentProducts),this.productsCached[this.currentIndex]=this.currentProducts,this.renderProducts()}catch(t){console.error(t)}}renderProducts(){const{tabs:t}=this.props.copywriting;if(!t||!t.length)return;const e=this.productsCached[this.currentIndex].reduce(((t,e,n)=>`${t}${this.renderProduct(e,n)}`),"");this.refs[`panel-${this.currentIndex}`].innerHTML=`\n            <h3 class='sr-only'>${t[this.currentIndex].label}</h3>\n            <div class='products'>${e}</div>\n        `}renderProduct(t,e){const n=this.priceFormatter.html?this.priceFormatter.html(this.currency,t.price):this.priceFormatter.short(this.currency,t.price);return`\n        <div class='product'\n            data-product-item-id='${t.internationalId}'\n            data-product-section='Page Builder - Hero Product Showcase'\n            data-product-position='${e+1}'>\n            <img\n                loading="lazy" src="${t.responsiveImages.standard}${((t="medium",e="375",n="1024",s="1920",i="3840")=>r.is.mobile?o(t,e):r.is.tablet?o(t,n):r.is.desktop?o(t,s):o(t,i))("product","252","252","126","252")}"\n                alt="${t.name}"\n                aria-hidden='true' />\n            <h4 class='t-xs-700-caps'>${t.name}</h4>\n            <div class='price'>\n                <p class='t-xs-700-caps'>${n}</p>\n                ${this.renderAddToCart(t,e)}\n            </div>\n        </div>`}renderAddToCart(t,e){const{heading:n}=this.props.copywriting;return`\n            <nb-add-to-cart\n                sku="${t.internationalId}"\n                longSku="${t.id}"\n                buttonSize="small"\n                showPrice\n                range='${n}'\n                position='${e+1}'\n            ></nb-add-to-cart>\n        `}initSlider(t){if(!t)return;const{tabs:e}=this.props.copywriting;e&&e.length&&(this.slider=t,this.slider.lastScrollPosition=this.slider.scrollLeft,this.slider.itemNumber=e.length,this.getSliderPositions(),this.getSliderWidth(),this.bindSliderScroll())}getSliderPositions(){this.slider.sliderPositions=[],this.querySelectorAll(".panel").forEach((t=>{this.slider.sliderPositions.push(t.offsetLeft)}))}getSliderWidth(){this.slider.width=this.slider.clientWidth}bindSliderScroll(){this.slider.addEventListener("scroll",this.boundSliderScroll)}unbindSliderScroll(){this.slider.removeEventListener("scroll",this.boundSliderScroll)}goSlider(){this.unbindSliderScroll(),this.slider.scrollTo({left:this.slider.sliderPositions[this.currentIndex],behavior:"smooth"}),setTimeout((()=>{this.bindSliderScroll()}),1e3)}onSliderScroll(){this.isScrolling&&clearTimeout(this.isScrolling),this.isScrolling=setTimeout((()=>{const t=this.slider.scrollLeft,e=this.slider.sliderPositions.indexOf(t);e>=0&&(this.switchTabs(e,!0),this.panelElements[e].focus())}),100)}setButtonSelected(){this.buttonElements&&(this.buttonElements.forEach((t=>{t.setAttribute("aria-selected","false"),t.setAttribute("tabindex","-1")})),this.panelElements.forEach((t=>{t.setAttribute("tabindex","-1"),t.setAttribute("aria-hidden",!0),this.setChildrenNotFocusable(t,!0)})),this.buttonElements[this.currentIndex].setAttribute("aria-selected","true"),this.buttonElements[this.currentIndex].removeAttribute("tabindex"),this.panelElements[this.currentIndex].setAttribute("tabindex","0"),this.panelElements[this.currentIndex].removeAttribute("aria-hidden"),this.setChildrenNotFocusable(this.panelElements[this.currentIndex],!1))}setChildrenNotFocusable(t,e=!0){const n=t.querySelectorAll('button, [href], [tabindex="0"]');n&&n.forEach((t=>{e?t.setAttribute("tabindex","-1"):t.removeAttribute("tabindex")}))}handleClick(t){this.switchTabs(t.target.dataset.index)}keyNavTab(t){switch(t.key){case"ArrowLeft":t.preventDefault(),this.currentIndex>0&&(this.currentIndex--,this.keyNavSwitchTab());break;case"ArrowRight":t.preventDefault(),this.currentIndex<this.buttonElements.length-1&&(this.currentIndex++,this.keyNavSwitchTab());break;case"Home":t.preventDefault(),this.currentIndex=0,this.keyNavSwitchTab();break;case"End":t.preventDefault(),this.currentIndex=this.buttonElements.length-1,this.keyNavSwitchTab()}}keyNavSwitchTab(){this.switchTabs(this.currentIndex),this.buttonElements[this.currentIndex].focus()}bindEvent(){this.unbindEvent(),this.buttonElements&&this.buttonElements.forEach((t=>{t.addEventListener("click",this.boundHandleClick)})),this.tabs&&this.tabs.addEventListener("keydown",this.boundKeyNavTab)}unbindEvent(){this.buttonElements&&this.buttonElements.forEach((t=>{t.removeEventListener("click",t.boundHandleClick)})),this.tabs&&this.tabs.removeEventListener("keydown",this.boundKeyNavTab)}disconnectedCallback(){this.unbindEvent()}}customElements.get("nb-hero-product-showcase")||customElements.define("nb-hero-product-showcase",l);export{l as default};
