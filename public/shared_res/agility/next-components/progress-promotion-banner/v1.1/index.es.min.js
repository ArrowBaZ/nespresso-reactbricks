const e=e=>null==e;window.gtmDataObject=window.gtmDataObject||[];class t extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(e=null){const t=e||this.attributes;let n;try{n=[...t].reduce(((e,t)=>({...e,[t.nodeName]:t.nodeValue})),{});const e=[...t].find((e=>"data"===e.nodeName));return null==e?n:{...n,...JSON.parse(e.nodeValue)}}catch(e){console.log("ERROR: No data",e)}}render(e=!1){e&&(this.innerHTML="");const t=(e,n)=>{const s=e=>3===e.nodeType?"text":8===e.nodeType?"comment":e.tagName.toLowerCase(),i=e=>e.childNodes&&e.childNodes.length>0?null:e.textContent;var r=Array.prototype.slice.call(n.childNodes),a=Array.prototype.slice.call(e.childNodes),o=r.length-a.length;if(o>0)for(;o>0;o--)r[r.length-o].parentNode.removeChild(r[r.length-o]);a.forEach((function(e,a){if(r[a])if(s(e)===s(r[a])){var o=i(e);if(o&&o!==i(r[a])&&(r[a].textContent=o),r[a].childNodes.length>0&&e.childNodes.length<1)r[a].innerHTML="";else{if(r[a].childNodes.length<1&&e.childNodes.length>0){var l=document.createDocumentFragment();return t(e,l),void r[a].appendChild(l)}e.childNodes.length>0&&t(e,r[a])}}else r[a].parentNode.replaceChild(e.cloneNode(!0),r[a]);else n.appendChild(e.cloneNode(!0))}))},n=(s=this.template,(new DOMParser).parseFromString(s,"text/html").body);var s;t(n,this)}loadTemplate(e="",t=!1){this.template=""===e?this.template:`${e}`,this.render(t)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",t);const n={get is(){const{innerWidth:e,devicePixelRatio:t}=window;return{mobile:e<768,mobile_tablet:e<1024,tablet:e>=768&&e<1024,desktop:e>=1024&&t<=1,retina:e>=1024&&t>1}},lt:e=>window.innerWidth<e};class s extends HTMLElement{constructor(){super(),this.props={},this.currentCapsules=0,this.finalThresholdCapsules=0,this.currentHeading="",this.currentDescription="",this.mainImage="",this.mainGiftAdded=!1,this.boundExpandCollapse=this.expandCollapse.bind(this)}connectedCallback(){this.props=(t=>{const n=(e=>e.find((e=>"data"===e.nodeName)))([...t]),s=[...t].filter((e=>"data"!==e.nodeName)).reduce(((e,t)=>({...e,[t.nodeName]:t.nodeValue})),{});if(e(n))return s;try{return{...s,...JSON.parse(n.nodeValue)}}catch(e){console.log("ERROR: No data",e)}})(this.attributes);const{campaign:t}=this.props;var n;this.render(),n={eventAction:"Promo Impression - On Load",ecommerce:{promoView:{promotions:[{...t}]}}},window.gtmDataObject.push({event:"impression",eventRaisedBy:"Web component",eventAction:"Promo Impression - On Scroll",ecommerce:{},...n}),this.isWindowNapiActive?this.readCart():console.warn("window.napi is not active ")}render(){const{contrast:e="light"}=this.props.layout;this.setAttribute("contrast",e),this.barPanel(),this.innerHTML=`\n            ${this.renderOuterBar()}\n            ${this.renderPopin()}\n        `,this.termsContent=this.querySelector("#pb-termsContent"),this.termsLink=this.querySelector("#pb-termsLink"),this.bindEvents()}renderOuterBar(){return`\n            <aside>\n                <div class="pb-wrap">\n                    ${this.renderMainProgress()}\n                    ${this.renderMainHeading()}\n                    ${this.renderCtaPopin()}\n                </div>\n            </aside>\n        `}renderMainProgress(){const e=this.percentage(this.currentCapsules,360),t=e>360?360:e;return`\n            <div class="pb-wrap-left">\n                <div class="pb-wrap-bar" data-progress="${t}" style="--progress: ${t}deg;"></div>\n                ${this.renderIconImage(this.mainImage)}\n                ${this.renderIconGiftAdded(this.mainGiftAdded)}\n            </div>\n        `}renderIconImage(e,t){return e?`<img loading="lazy" src="${e}" alt="${t}" />`:""}renderIconGiftAdded(e){return e?'<div class="pb-wrap-svg">\n                    <nb-icon icon="check-mark" />\n                </div>':""}renderMainHeading(){return`\n            <div class="pb-wrap-text ${n.is.mobile?"t-xs-500":"t-sm-400"}">\n                <strong>${this.currentHeading}</strong>\n                ${n.is.mobile&&!this.currentCapsules?"":`<span>${this.currentDescription}</span>`}\n            </div>\n        `}renderCtaPopin(){const{contrast:e="light"}=this.props.layout,{popin_id:t,label_expand:n}=this.props.copywriting,{id:s,name:i,position:r,creative:a}=this.props.campaign;if(t)return`<nb-cta\n                    campaign_id="${s}"\n                    campaign_name="${i}"\n                    campaign_position="${r}"\n                    campaign_creative="${a}"\n                    variation='navigation'\n                    popin_id="${t}"\n                    contrast="${"light"===e?"black":"white"}"\n                    icon_left='plus-16'\n               >${n}</nb-cta>`}renderPopin(){const{popin_id:e,heading:t,close:n}=this.props.copywriting,{contrast:s="light"}=this.props.layout;return e?`<nb-popin\n                id="${e}"\n                popin_id="${e}"\n                heading="${t}"\n                variation="next"\n                contrast="${s}"\n                bgcolor=""\n                label_close="${n}"\n                size="M"\n            >\n                ${this.renderPopinSubHeading()}\n                ${this.renderPopinDescription()}\n                ${this.renderProgressBar()}\n                ${this.renderDisclaimer()}\n                ${this.renderTermsLink()}\n                ${this.renderTermsText()}\n            </nb-popin>`:""}renderPopinSubHeading(){return`<p class="t-sm-400-sl" aria-live="polite"><strong>${this.currentHeading}</strong></p>`}renderPopinDescription(){return`<p class="t-sm-400-sl" aria-live="polite">${this.currentDescription}</p>`}renderProgressBar(){let e=this.percentage(this.currentCapsules)||2;return`\n        <div class="pb-popin-wrap">\n            <div class="pb-popin-bar">\n                <div class="pb-popin-gifts">\n                    <span class="move" aria-hidden="true">\n                    <p class="t-sm-400">${this.renderProgressNum(0)}</p></span>\n                    ${this.positionOffers()}\n                    <span aria-hidden="true" class="value move" style="left:${e}%;">\n                        <p class="t-sm-400">${this.renderProgressNum(this.currentCapsules)}</p>\n                    </span>\n                </div>\n                <progress\n                    role="progressbar"\n                    min="0"\n                    aria-valuemin="0"\n                    max="${this.finalThresholdCapsules}"\n                    aria-valuemax="${this.finalThresholdCapsules}"\n                    value="${this.currentCapsules}"\n                    aria-valuenow="${this.currentCapsules}"\n                    aria-label="${this.currentDescription}">\n                </progress>\n            </div>\n        </div>\n        `}renderProgressNum(e){return`<p class="t-2xs-500-sl">${e}</p>`}positionOffers(){const{offers:e}=this.props.copywriting;return e.map(((t,n)=>this.renderOffer(t,n+1===e.length,n))).join("")}renderOffer(e,t,n){const{offers:s}=this.props.copywriting,{capsule:i,image:r,alt:a,cumulative:o}=e,l=parseInt(i),d=this.currentCapsules>=l,c=this.currentCapsules===l;let p=!1;(o&&d||t&&d||c)&&(p=!0),!t&&this.currentCapsules>l&&this.currentCapsules<parseInt(s[n+1].capsule)&&(p=!0);const h=this.percentage(l);return`\n            <span style="${t?"right:0":`left: ${h}`}%" class="${t?"":"mid"}">\n                <div class="icon-wrap ${t?"last":""}${d?" active":""}">\n                    ${this.renderIconImage(r,a)}\n                    ${this.renderIconGiftAdded(p)}\n                </div>\n                ${this.renderProgressNum(l)}\n            </span>\n        `}renderDisclaimer(){const{a11y_disclaimer_label:e,disclaimer_txt:t}=this.props.copywriting;if(!t)return"";let n="";return e&&(n=`aria-label="${e}"`),`<small class="disclaimer t-2xs-500" aria-live="polite" aria-atomic="false" ${n}">\n                <sub aria-hidden="true">*</sub>${t}</small>`}renderTermsLink(){const{contrast:e="light"}=this.props.layout,{terms_link_txt:t}=this.props.copywriting;return t?`<nb-link id="pb-termsLink" icon_right="chevron-down" size="small" color=${"light"===e?"black":"white"}>${t}</nb-link>`:""}renderTermsText(){const{terms_txt:e}=this.props.copywriting;return e?`<div class="hide pb-terms-content t-2xs-500-sl" id="pb-termsContent">${e}</div>`:""}barPanel(){const{offers:e,heading:t,description:n,gifts_image:s,success_heading:i,success_description:r}=this.props.copywriting,a=e.length,o=e[a-1];if(this.finalThresholdCapsules=parseInt(o.capsule),this.mainGiftAdded=!1,this.mainImage=s,this.setHeadingDescription(t,n),!this.currentCapsules||!a)return"";if(this.currentCapsules>=this.finalThresholdCapsules)return this.mainImage=o.image,this.mainGiftAdded=!0,void this.setHeadingDescription(i,r);let l={};const d=this;e.every(((t,n)=>{const s=parseInt(t.capsule),i=n+1,r=e[i];return d.currentCapsules<s?(l={...l,...t},n&&(this.mainImage=e[n-1].image,this.mainGiftAdded=!0),!1):d.currentCapsules!==s||(this.mainImage=t.image,this.mainGiftAdded=!0,a===i?(l={...l,...t},!1):(l={...l,...r},!1))}));const{title:c,message:p,capsule:h}=l;this.setHeadingDescription(c,p,h)}setHeadingDescription(e,t,n){const s=t.includes("{countPlaceholder}");if(this.currentHeading=e,this.currentDescription=t,s){const e=parseInt(n)-this.currentCapsules;this.currentDescription=t.replace("{countPlaceholder}",e)}}async readCart(){const e=this,t=await window.napi.cart().read();this.calculateTheCapsuleCount(t),window.napi.data().on("cart.update",(()=>{window.napi.cart().read().then((t=>{e.calculateTheCapsuleCount(t)})).catch((e=>console.error(e)))}))}calculateTheCapsuleCount(e){if(!e.length)return void this.barRerender(0);const{technology:t,exclude:n}=this.props.copywriting;let s=e.map((e=>e.productId.split("prod/").pop()));const i=n.trim();if(i){let e=i.split(",");if(s=s.filter((t=>-1===e.indexOf(t))),!s.length)return}Promise.all(s.map((e=>window.napi.catalog().getProduct(e)))).then((n=>{if(!n)return;const s=[].concat(n).filter((e=>"capsule"===e.type));if(!s.length)return void this.barRerender(0);let i=[];s.forEach((n=>{const s=e.filter((e=>e.productId===n.id)),r=n.bundled;if("both"!==t){const e=n.technologies.map((e=>e.split("/").pop()));if(-1===e.indexOf(t))return}r?i.push(s[0].quantity*n.unitQuantity):i.push(s[0].quantity)}));const r=i.reduce((function(e,t){return e+t}),0);this.barRerender(r)})).catch((()=>{throw new Error("getProduct fail on sku")}))}barRerender(e){this.currentCapsules=e,this.unbindEvents(),this.render()}percentage(e,t){return parseInt((e/this.finalThresholdCapsules*(t||100)).toFixed(3))}isWindowNapiActive(){return!!window.napi}expandCollapse(e){e.preventDefault(),this.termsContent.classList.contains("hide")?(this.termsLink.classList.add("exapnd"),this.termsContent.classList.remove("hide"),this.termsContent.setAttribute("expanded","true")):(this.termsLink.classList.remove("exapnd"),this.termsContent.classList.add("hide"),this.setAttribute("expanded","false"))}bindEvents(){this.termsLink.addEventListener("click",this.boundExpandCollapse)}unbindEvents(){this.termsLink.removeEventListener("click",this.boundExpandCollapse)}disconnectedCallback(){this.unbindEvents()}}customElements.get("nb-progress-promotion-banner")||customElements.define("nb-progress-promotion-banner",s);export{s as default};
