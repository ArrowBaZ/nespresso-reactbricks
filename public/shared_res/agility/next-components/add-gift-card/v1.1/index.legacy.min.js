window.gtmDataObject=window.gtmDataObject||[];function t(t){const e=document.implementation.createHTMLDocument("");return e.body.innerHTML=t,e.body.childNodes}class e extends class{constructor(t,e){this.observer=new IntersectionObserver((t=>this.onChange(t)),{threshold:[0],rootMargin:"0% 0%"}),this.el=t,this.data=e,this.el instanceof Element&&this.observer.observe(this.el)}onChange(t){t.forEach((t=>{t.isIntersecting&&(this.track(t),this.observer.unobserve(t.target))}))}track(){window.requestIdleCallback((()=>this.runTrack()))}runTrack(){var t;this.data.id&&null!==this.data.id&&""!==this.data.id&&(t={ecommerce:{promoView:{promotions:[this.data]}}},window.gtmDataObject.push({event:"impression",eventRaisedBy:"Web component",eventAction:"Promo Impression - On Scroll",ecommerce:{},...t}))}}{constructor(t,e,n,i,s){super(t),this.data=e,this.currency=n,this.range=i,this.position=s}async runTrack(){if(!this.data)return;const t=await this.getCategories(this.data);window.impressionsOnScroll=window.impressionsOnScroll||{},window.impressionsOnScroll[this.data.internationalId]=this.buildGTMProductObject(this.data,t)}async getPLPCategory(t){return(await window.getPLPData()).data.configuration.eCommerceData.categories.find((e=>e.id===t))}async getCategoriesWithPlpData(t){const e="/machineTechno/",n=[...t.cupSizes,...t.flavors,...t.ranges,...t.technologies];return(await Promise.all(n.map((async t=>{const n=await this.getPLPCategory(t);return!n&&(t=>-1!==t.indexOf(e))(t)?(t=>t.substr(t.indexOf(e)+e.length))(t):n.name})))).join("|")}async getCategories(t){return t?window.getPLPData?this.getCategoriesWithPlpData(t):Promise.all(t.supercategories.map((t=>window.napi.catalog().getCategory(t)))).then((t=>{const e=[];for(const n of t){const t=n.code;if(!t)return;(~t.indexOf("-cupSize-")||~t.indexOf("-range-")||~t.indexOf("capsule-aromatic-")||~t.indexOf("machine-keyFeature-")||~t.indexOf("machine-color-")||~t.indexOf("accessory-collection-")||~t.indexOf("accessory-hero-month"))&&e.push(n.name.toLowerCase())}return e.join("|")})):""}buildGTMProductObject(e,n){let i;"capsule"===e.type?i="capsules":"accessory"===e.type?i="accessories":"machine"===e.type&&(i="machines");let s=null;e.technologies&&(s=e.technologies.map((t=>function(t=""){return t[0].toUpperCase()+t.slice(1)}(t.split("/")[2]))).join("|||"));let o="";null!=e.productSelections&&(o=e.productSelections.join("|"));const a={brand:"Nespresso",category:i,dimension43:"false",dimension44:"false",dimension53:e.legacyId,dimension54:t(e.name)[0].textContent,dimension55:n,dimension56:s,dimension57:this.isBundled(e)?"bundled":"single",dimension130:o,id:e.internationalId,name:t(e.internationalName)[0].textContent,price:e.price};return this.range&&(a.list=this.range),this.position&&(a.position=parseInt(this.position)),a}isBundled(t){let e=1===t.salesMultiple&&t.unitQuantity>1;return t.bundled?e=t.bundled:t.salesMultiple>1&&1===t.unitQuantity&&(e=!1),e}}const n=t=>{const e=(t=>t.find((t=>"data"===t.nodeName)))([...t]),n=[...t].filter((t=>"data"!==t.nodeName)).reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});if(i(e))return n;try{return{...n,...JSON.parse(e.nodeValue)}}catch(t){console.log("ERROR: No data",t)}},i=t=>null==t;class s extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(t=null){const e=t||this.attributes;let n;try{n=[...e].reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});const t=[...e].find((t=>"data"===t.nodeName));return null==t?n:{...n,...JSON.parse(t.nodeValue)}}catch(t){console.log("ERROR: No data",t)}}render(t=!1){t&&(this.innerHTML="");const e=(t,n)=>{const i=t=>3===t.nodeType?"text":8===t.nodeType?"comment":t.tagName.toLowerCase(),s=t=>t.childNodes&&t.childNodes.length>0?null:t.textContent;var o=Array.prototype.slice.call(n.childNodes),a=Array.prototype.slice.call(t.childNodes),r=o.length-a.length;if(r>0)for(;r>0;r--)o[o.length-r].parentNode.removeChild(o[o.length-r]);a.forEach((function(t,a){if(o[a])if(i(t)===i(o[a])){var r=s(t);if(r&&r!==s(o[a])&&(o[a].textContent=r),o[a].childNodes.length>0&&t.childNodes.length<1)o[a].innerHTML="";else{if(o[a].childNodes.length<1&&t.childNodes.length>0){var d=document.createDocumentFragment();return e(t,d),void o[a].appendChild(d)}t.childNodes.length>0&&e(t,o[a])}}else o[a].parentNode.replaceChild(t.cloneNode(!0),o[a]);else n.appendChild(t.cloneNode(!0))}))},n=(i=this.template,(new DOMParser).parseFromString(i,"text/html").body);var i;e(n,this)}loadTemplate(t="",e=!1){this.template=""===t?this.template:`${t}`,this.render(e)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",s);const o=({eventName:t,args:e,element:n})=>{let i;n=n||window,e?i=new CustomEvent(t,{detail:e,bubbles:!0}):"function"==typeof Event?i=new Event(t):(i=document.createEvent("Event"),i.initEvent(t,!0,!0)),n.dispatchEvent(i)},a=t=>{if(t.detail)return t.detail},r=(t,e,n)=>{if(t.nwcSwipeEvents)return;t.nwcSwipeEvents=!0,e.addEventListener("touchstart",(function(t){if("true"===t.target.getAttribute("data-swipe-ignore"))return;d=t.target,function(t){if(void 0===n||!n.contains(t))return;l=[],c=[];for(;t!==n;)l.push(t.scrollTop),c.push(t.scrollLeft),t=t.parentNode}(d),r=Date.now(),i=t.touches[0].clientX,s=t.touches[0].clientY,o=0,a=0}),!1),e.addEventListener("touchmove",(function(t){if(!i||!s)return;let e=t.touches[0].clientX,n=t.touches[0].clientY;o=i-e,a=s-n}),!1),e.addEventListener("touchend",(function(e){if(d!==e.target)return;const n=.25*t.innerHeight,l=.5*t.innerWidth;let c=parseInt(p(d,"data-swipe-threshold",n),10),h=parseInt(p(d,"data-swipe-threshold",l),10),m=parseInt(p(d,"data-swipe-timeout","500"),10),b=Date.now()-r,E="",v=e.changedTouches||e.touches||[];Math.abs(o)>Math.abs(a)?Math.abs(o)>h&&b<m&&(o>0?u("left",e)&&(E="swiped-left"):u("right",e)&&(E="swiped-right")):Math.abs(a)>c&&b<m&&(a>0?u("up",e)&&(E="swiped-up"):u("down",e)&&(E="swiped-down"));if(""!==E){let t={dir:E.replace(/swiped-/,""),touchType:(v[0]||{}).touchType||"direct",xStart:parseInt(i,10),xEnd:parseInt((v[0]||{}).clientX||-1,10),yStart:parseInt(s,10),yEnd:parseInt((v[0]||{}).clientY||-1,10)};d.dispatchEvent(new CustomEvent("swiped",{bubbles:!0,cancelable:!0,detail:t})),d.dispatchEvent(new CustomEvent(E,{bubbles:!0,cancelable:!0,detail:t}))}i=null,s=null,r=null}),!1);let i=null,s=null,o=null,a=null,r=null,d=null,l=[],c=[];function u(t,e){if(void 0===n)return!0;let i=e.target,s=!0,o=0;for(;i!==n&&s;){if(h(i))switch(t){case"up":s=l[o]===i.scrollHeight-i.clientHeight;break;case"down":s=0===l[o];break;case"left":s=c[o]===i.scrollWidth-i.clientWidth;break;case"right":s=0===c[o];break;default:s=!0}i=i.parentNode,o++}return s}function h(t){return t.scrollHeight>t.clientHeight||t.scrollWidth>t.clientWidth}function p(t,n,i){for(;t&&t!==e.documentElement;){let e=t.getAttribute(n);if(e)return e;t=t.parentNode}return i}};function d(t,e){const n=t.parentNode;if(n===document.getElementsByTagName("body")[0])return;const i=n.children;for(const n of i)n!==t&&(e?n.setAttribute("aria-hidden",e):n.removeAttribute("aria-hidden"));d(n,e)}var l=t=>{const e=document.createElement("DIV");e.classList.add("nb-overlay"),e.addEventListener("click",(()=>{o({eventName:"WEB_COMPONENT_QS_CLOSE",args:{id:t}})})),document.body.appendChild(e),setTimeout((()=>{e.classList.add("fadein")}),1)},c=()=>{if(!document.getElementsByClassName("nb-overlay").length)return;const t=document.getElementsByClassName("nb-overlay")[0];t.classList.remove("fadein"),setTimeout((()=>{t.remove()}),1200)};const u={get is(){const{innerWidth:t,devicePixelRatio:e}=window;return{mobile:t<768,mobile_tablet:t<1024,tablet:t>=768&&t<1024,desktop:t>=1024&&e<=1,retina:t>=1024&&e>1}},lt:t=>window.innerWidth<t};class h extends HTMLElement{constructor(){super(),this.props={},this.boundOpen=this.open.bind(this),this.boundClose=this.close.bind(this),this.boundEscapeClose=this.escapeClose.bind(this),this.boundFocus=this.focus.bind(this),this.boundFocusin=this.focusIn.bind(this),this.boundClickOutside=this.clickOutside.bind(this),this.boundSwipeDown=this.swipeDown.bind(this),this.boundNumericKeypress=this.numericKeypress.bind(this),this.boundValueChanged=this.valueChanged.bind(this),this.boundAddToCart=this.addToCart.bind(this)}connectedCallback(){this.props=n(this.attributes),this.setAttribute("id","quantity-selector-id"),this.style.display="none",this.ariaModal=!1,this.oldValue="",this.render()}disconnectedCallback(){this.hasEvent&&this.unbindEvent()}render(){this.hasEvent&&this.unbindEvent();const{a11y_qs_label:t,a11y_qs_description:e,a11y_predefined_quantity:n,a11y_predefined_description:i,a11y_custom_quantity:s,a11y_custom_description:o,label_choose_quantity:a,label_button_ok:r,step:d,max:l}=this.props;this.setAttribute("role","dialog"),this.setAttribute("aria-hidden","true"),this.innerHTML=`\n            <form aria-label="${t}" aria-description="${e}">\n                <fieldset aria-label="${n}" aria-description="${i}">\n                    ${this.renderItems()}\n                </fieldset>\n                <fieldset class="custom" aria-label="${s}" aria-description="${o}">\n                    <div>\n                        <input id="other_quantity" type="number" min="0" step="${d}" max="${l}" aria-label="${a}" pattern="[0-9]*"/>\n                        <label for="other_quantity" aria-hidden="true">${a}</label>\n                    </div>\n                    <button type="button">${r}</button>\n                </fieldset>\n            </form>\n        `,setTimeout((()=>{this.style.display="inherit"}),100),function(t){const e=t.querySelectorAll('button, [href], input, select, textarea, [tabindex="0"]');t.firstFocusable=e[0],t.lastFocusable=e[e.length-1],t.lastFocused=t.firstFocusable}(this),this.firstButtonElement=this.querySelector("ul li:first-child button"),this.buttonElements=this.querySelectorAll("ul button"),this.inputElement=this.querySelector("input"),this.buttonOK=this.querySelector(".custom button"),this.bindEvent()}renderItems(){const{quantities:t=[]}=this.props;return`<ul>${t.reduce(((t,e)=>`${t}${this.renderItem(e)}`),"")}</ul>`}renderItem(t){const{a11y_add_label:e}=this.props;return`<li><button aria-label="${e} ${t}" value="${t}" type="button">${t}</button></li>`}addLock(){u.is.mobile&&(document.documentElement.classList.add("scroll-lock"),l(this.id))}removeLock(){u.is.mobile&&(document.documentElement.classList.remove("scroll-lock"),c())}switchAriaModal(){this.ariaModal=!this.ariaModal,this.setAttribute("aria-modal",this.ariaModal),d(this,this.ariaModal)}setOpeningPosition(){const{top:t}=this.parentNode.getBoundingClientRect();t<280?this.classList.add("open-bottom"):this.classList.remove("open-bottom")}async open(t){if(await this.ready,this.isOpen)return;a(t).id===this.id&&(this.isOpen=!0,this.addEventListener("transitionend",this.boundFocus),document.addEventListener("focusin",this.boundFocusin),this.openingSource=document.activeElement,u.is.mobile||this.setOpeningPosition(),this.addLock(),this.switchAriaModal(),this.setAttribute("aria-hidden","false"),await new Promise((t=>{setTimeout((()=>{this.classList.add("isOpen"),t()}),300)})),u.is.mobile||document.body.addEventListener("click",this.boundClickOutside))}close(){this.isOpen&&(this.isOpen=!1,this.addEventListener("transitionend",this.boundFocus),document.removeEventListener("focusin",this.boundFocusin),u.is.mobile||document.body.removeEventListener("click",this.boundClickOutside),this.removeLock(),this.switchAriaModal(),this.setAttribute("aria-hidden","true"),this.classList.remove("isOpen"),o({eventName:"WEB_COMPONENT_QS_CLOSED",args:{id:this.id},element:this}))}focus(){this.removeEventListener("transitionend",this.boundFocus),this.isOpen?this.firstButtonElement.focus():this.openingSource.focus()}focusIn(t){!function(t,e,n){e.contains(t.target)?e.lastFocused=t.target:e.lastFocused===e.firstFocusable?n?e.lastFocusable.focus():e.firstFocusable.focus():n?e.firstFocusable.focus():e.lastFocusable.focus()}(t,this,!0)}escapeClose(t){"Escape"===t.key&&this.isOpen&&this.close()}swipeDown(){this.isOpen&&this.close()}clickOutside(t){!this.contains(t.target)&&this.isOpen&&this.close()}numericKeypress(t){(!/\d/i.test(t.key)||t.target.value.length+1>this.props.max.length)&&t.preventDefault()}valueChanged(t){""!==t.target.value?t.target.classList.add("filled"):t.target.classList.remove("filled"),t.target.value>this.props.max&&(t.target.value=this.props.max)}async addToCart(t){let e="";if(t.target===this.buttonOK){if(e=this.inputElement.value,""===e)return}else e=t.target.value;o({eventName:"WEB_COMPONENT_ADD_TO_CART",args:{quantity:e},element:this}),this.close()}bindEvent(){this.hasEvent=!0,window.addEventListener("WEB_COMPONENT_QS_OPEN",this.boundOpen),window.addEventListener("WEB_COMPONENT_QS_CLOSE",this.boundClose),document.addEventListener("keydown",this.boundEscapeClose),this.buttonElements.forEach((t=>{t.boundAddToCart=this.addToCart.bind(t),t.addEventListener("click",this.boundAddToCart)})),this.inputElement&&(this.inputElement.addEventListener("keypress",this.boundNumericKeypress),this.inputElement.addEventListener("change",this.boundValueChanged)),this.buttonOK&&this.buttonOK.addEventListener("click",this.boundAddToCart),u.is.mobile&&(r(window,document,this),document.addEventListener("swiped-down",this.boundSwipeDown),this.hasSwipeEvent=!0)}unbindEvent(){window.removeEventListener("WEB_COMPONENT_QS_OPEN",this.boundOpen),window.removeEventListener("WEB_COMPONENT_QS_CLOSE",this.boundClose),document.removeEventListener("keydown",this.boundEscapeClose),this.buttonElements.forEach((t=>{t.removeEventListener("click",this.boundAddToCart)})),this.inputElement&&(this.inputElement.removeEventListener("keypress",this.boundNumericKeypress),this.inputElement.removeEventListener("change",this.boundValueChanged)),this.buttonOK&&this.buttonOK.removeEventListener("click",this.boundAddToCart),this.hasSwipeEvent&&(document.removeEventListener("swiped-down",this.boundSwipeDown),this.hasSwipeEvent=!1),this.hasEvent=!1}}customElements.get("nb-qs")||customElements.define("nb-qs",h);class p extends HTMLElement{constructor(){super(),this.props={},this.sku="",this.currency="",this.boundOnAddToCart=this.onAddToCart.bind(this),this.boundOnCartUpdated=this.onCartUpdated.bind(this),this.boundOnQSClosed=this.onQSClosed.bind(this)}connectedCallback(){this.props=n(this.attributes);const{sku:t,price:e}=this.props;this.sku=t.trim(),this.price=e.trim(),this.render(),this.bindEvent()}render(){const{add_to_cart:t="large"}=this.props,{__INITIAL_CONFIG__:{translations:e={}}={}}=window,n=e["global.addtobag.button.add"]||"ADD TO CART",i=e["global.addtobag.button.update"]||"UPDATE BASKET";this.classList.add("cb-addToCard"),this.innerHTML=`\n            <nb-cta\n                variation="primary"\n                icon_right="plus-24"\n                add_to_cart="${t}"\n                label_update="${i}"\n                qs_id="quantity-selector-id">\n                ${n}\n            </nb-cta>\n        `,this.buttonElement=this.querySelector("nb-cta")}_isWindowNapiActive(){return!!window.napi}async onAddToCart(t){if(!window.CartManager||!this._isWindowNapiActive())return;const e=a(t).quantity;this.updateQuantity(e),0!==e&&await window.CartManager.updateGiftCard(this.props.sku,e,this.props.price),1!==e&&await window.napi.cart().update(this.props.sku,e)}updateQuantity(t){this.buttonElement.setAttribute("quantity",t)}onCartUpdated(t,e){const n=e.cartUpdates.items.find((t=>t.productInfo.productLocalSKU===this.sku&&t.price.productPrice===this.price));console.log("onCartUpdated",n)}onQSClosed(){this.removeEventListener("WEB_COMPONENT_ADD_TO_CART",this.boundOnAddToCart),this.qsElement.removeEventListener("WEB_COMPONENT_QS_CLOSED",this.boundOnQSClosed)}async _tracking(){if(!this._isWindowNapiActive())return new Promise.resolve;try{const t=window[window.config.padl.namespace].dataLayer.app.app.currency;!function(t,n,i,s,o){const a=new e(t,n,i,s,o)}(this,await window.napi.catalog().getProduct(this.sku),t)}catch(t){throw new Error(`getProduct fail on sku ${this.sku}`)}}async openQuantitySelector(){this.renderQuantitySelector(),this.contains(this.qsElement)||(await this.qsElement.close(),await this.appendChild(this.qsElement)),this.addEventListener("WEB_COMPONENT_ADD_TO_CART",this.boundOnAddToCart),this.qsElement.addEventListener("WEB_COMPONENT_QS_CLOSED",this.boundOnQSClosed),o({eventName:"WEB_COMPONENT_QS_OPEN",args:{id:"quantity-selector-id"}})}renderQuantitySelector(){if(this.qsElement=document.getElementById("quantity-selector-id"),null!==this.qsElement)return;const{quantity_selector:t}=this.props;this.qsElement=document.createElement("nb-qs");const e={id:"quantity-selector-id",a11y_qs_label:t.a11y_qs_label,a11y_qs_description:t.a11y_qs_description,a11y_predefined_quantity:t.a11y_predefined_quantity,a11y_predefined_description:t.a11y_predefined_description,a11y_add_label:t.a11y_add_label,quantities:t.quantities,step:t.step,max:t.max,a11y_custom_quantity:t.a11y_custom_quantity,a11y_custom_description:t.a11y_custom_description,label_choose_quantity:t.label_choose_quantity,label_button_ok:t.label_button_ok};this.qsElement.setAttribute("data",JSON.stringify(e))}bindEvent(){this.unbindEvent(),this.buttonElement&&(this.boundQuantitySelectorClick=this.openQuantitySelector.bind(this),this.buttonElement.addEventListener("click",this.boundQuantitySelectorClick)),window.napi.data().on("cart.update",this.boundOnCartUpdated)}unbindEvent(){this.buttonElement&&this.buttonElement.removeEventListener("click",this.boundQuantitySelectorClick),this.removeEventListener("WEB_COMPONENT_ADD_TO_CART",this.boundOnAddToCart),this.qsElement&&this.qsElement.removeEventListener("WEB_COMPONENT_QS_CLOSED",this.boundOnQSClosed),window.napi.data().off("cart.update",this.boundOnCartUpdated)}disconnectedCallback(){this.unbindEvent()}}customElements.get("nb-add-gift-card")||customElements.define("nb-add-gift-card",p);export{p as default};
