function t(t,e=!0,i=!1){return new Promise(((o,n)=>{const s=document.createElement("script"),a=document.getElementsByTagName("script")[0];s.async=e,s.defer=i,s.addEventListener("load",(()=>o())),s.addEventListener("error",(()=>n(new Error("Loading script")))),s.src=t,a.parentNode.insertBefore(s,a)}))}class e{constructor(){this.promise=new Promise(((t,e)=>{this.reject=e,this.resolve=t}))}}const i=()=>{const t=window[window?.padlNamespace]?.dataLayer;return t?t.app.app.market.toLocaleLowerCase():"ch"};class o{constructor(){this.iframeApi=function(){const o=new e;return(window.YT&&window.YT.Player||"cn"===i())&&o.resolve(),t("https://www.youtube.com/iframe_api",!1).then((()=>{window.YT.ready((()=>o.resolve()))})),o.promise}()}attach(t,e,i,o=1,n={}){let s={};return i&&(s={playlist:e,controls:0,loop:1}),new Promise((a=>{this.iframeApi.then((()=>{const l=new window.YT.Player(t,{videoId:e,host:"https://www.youtube-nocookie.com",playerVars:{enablejsapi:1,rel:0,fs:0,autoplay:o,...s,...n},events:{onReady:()=>{i&&l.mute(),a(l)},onStateChange:()=>({}),onError:()=>({})}})}))}))}}const n=t=>{const e=getComputedStyle(t),i=e.getPropertyValue("width")||0,o=e.getPropertyValue("margin-left")||0,n=e.getPropertyValue("margin-right")||0;return parseInt(i)+parseInt(o)+parseInt(n)},s=t=>{const e=getComputedStyle(t),i=e.getPropertyValue("height")||0,o=e.getPropertyValue("margin-top")||0,n=e.getPropertyValue("margin-bottom")||0;return parseInt(i)+parseInt(o)+parseInt(n)};class a{constructor(){this.iframeApi=new Promise((e=>{t("https://player.youku.com/jsapi").then((()=>e()))}))}attach(t,e,i,o=1,a={}){let l={};if(i){const i=document.getElementById(t);l={playlist:e,controls:0,loop:1,autoplay:1,width:n(i),height:s(i)}}return new Promise((i=>{this.iframeApi.then((()=>{const n=new window.YKU.Player(t,{styleid:"0",client_id:"a3660779c8b57c32",vid:e,newPlayer:!0,autoplay:o,show_related:!1,width:640,height:360,...l,...a,events:{onPlayerReady:()=>i(n),onPlayStart:()=>({}),onPlay:()=>({}),onPlayEnd:()=>({}),onPause:()=>({}),onWaiting:()=>({}),onFullScreen:()=>({}),onPlayError:()=>({})}})}))}))}}class l extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(t=null){const e=t||this.attributes;let i;try{i=[...e].reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});const t=[...e].find((t=>"data"===t.nodeName));return null==t?i:{...i,...JSON.parse(t.nodeValue)}}catch(t){console.log("ERROR: No data",t)}}render(t=!1){t&&(this.innerHTML="");const e=(t,i)=>{const o=t=>3===t.nodeType?"text":8===t.nodeType?"comment":t.tagName.toLowerCase(),n=t=>t.childNodes&&t.childNodes.length>0?null:t.textContent;var s=Array.prototype.slice.call(i.childNodes),a=Array.prototype.slice.call(t.childNodes),l=s.length-a.length;if(l>0)for(;l>0;l--)s[s.length-l].parentNode.removeChild(s[s.length-l]);a.forEach((function(t,a){if(s[a])if(o(t)===o(s[a])){var l=n(t);if(l&&l!==n(s[a])&&(s[a].textContent=l),s[a].childNodes.length>0&&t.childNodes.length<1)s[a].innerHTML="";else{if(s[a].childNodes.length<1&&t.childNodes.length>0){var r=document.createDocumentFragment();return e(t,r),void s[a].appendChild(r)}t.childNodes.length>0&&e(t,s[a])}}else s[a].parentNode.replaceChild(t.cloneNode(!0),s[a]);else i.appendChild(t.cloneNode(!0))}))},i=(o=this.template,(new DOMParser).parseFromString(o,"text/html").body);var o;e(i,this)}loadTemplate(t="",e=!1){this.template=""===t?this.template:`${t}`,this.render(e)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",l);const r={get is(){const{innerWidth:t,devicePixelRatio:e}=window;return{mobile:t<768,mobile_tablet:t<1024,tablet:t>=768&&t<1024,desktop:t>=1024&&e<=1,retina:t>=1024&&e>1}},lt:t=>window.innerWidth<t},d=t=>null==t;class h extends HTMLElement{constructor(){super(),this.videoId=null,this.videoMobile=null,this.currentVideo=null,this.videoService="",this.containerId="",this.ccPolicyLanguage=null,this.ccPolicyCountry=null,this.ccLoadPolicy=null,this.displayControls=0,this.disabledKeyboard=1,this.isBackground=!1,this.autoPlay=0,this.loop=0,this.mute="false",this.allowPopinAutoplay=!1,this.isPlaying=!1,this.player=null,this.play=null,this.pause=null,this.stop=null,this.moveTo=null,this.loadInterupted=null,this.controlsReady=null,this._externalControl=this._externalControl.bind(this)}connectedCallback(){this.props=(t=>{const e=(t=>t.find((t=>"data"===t.nodeName)))([...t]),i=[...t].filter((t=>"data"!==t.nodeName)).reduce(((t,e)=>({...t,[e.nodeName]:e.nodeValue})),{});if(d(e))return i;try{return{...i,...JSON.parse(e.nodeValue)}}catch(t){console.log("ERROR: No data",t)}})(this.attributes),this.init()}init(){this.unbindEvent();const{video_id:t,video_mobile:e,container_id:i,video_service:o}=this.props;this.videoId=t||this.videoId,this.videoMobile=e||this.videoMobile,this.containerId=i||this.containerId,this.videoService=o||this.videoService,this.currentVideo=r.is.mobile&&""!==this.videoMobile&&null!==this.videoMobile?this.videoMobile:this.videoId,this.popinId=this.getAttribute("popin_id")||this.popinId,this.ccPolicyLanguage=this.getAttribute("ccPolicy_language")||this.ccPolicyLanguage,this.ccPolicyCountry=this.getAttribute("ccPolicy_country")||this.ccPolicyCountry,this.ccLoadPolicy=this.getAttribute("cc_load_policy")||this.ccLoadPolicy,this.displayControls=this.getAttribute("display_controls")||this.displayControls,this.isBackground="true"===this.getAttribute("is_background")||this.isBackground,this.autoPlay="true"===this.getAttribute("auto_play")?1:this.autoPlay,this.loop="true"===this.getAttribute("loop")?1:this.loop,this.mute=this.getAttribute("mute")||this.mute,this.allowPopinAutoplay="true"===this.getAttribute("allow_popin_autoplay")||this.allowPopinAutoplay,""!==this.popinId&&(this.boundOnPopinClosed=this.onPopinClosed.bind(this),window.addEventListener("WEB_COMPONENT_POPIN_CLOSED",this.boundOnPopinClosed),this.boundOnPopinOpened=this.onPopinOpened.bind(this),window.addEventListener("WEB_COMPONENT_POPIN_OPENED",this.boundOnPopinOpened),this.boundOnTogglePlayback=this.onTogglePlayback.bind(this),window.addEventListener("WEB_COMPONENT_VIDEO_TOGGLE",this.boundOnTogglePlayback)),this.currentVideo&&(this.render(),"local"===this.videoService?this.initLocal():this.controlsReady||("youku"===this.videoService?this.initYouku():this.initYoutube()),this.boundExternalControl=this._externalControl.bind(this),window.addEventListener("WEB_COMPONENT_VIDEO"+this.containerId,this.boundExternalControl))}async onPopinOpened(t){this.allowPopinAutoplay&&void 0!==this.popinId&&""!==this.popinId&&t.detail.id===this.popinId&&(await this.controlsReady,this.play())}async onPopinClosed(t){void 0!==this.popinId&&""!==this.popinId&&t.detail.id===this.popinId&&(await this.controlsReady,this.stop())}async onTogglePlayback(t){""!==this.popinId&&t.detail.id===this.popinId&&(await this.controlsReady,this.isPlaying?this.pause():this.play())}initYouku(){const t=this,e=new a;this.controlsReady=new Promise(((i,o)=>{this.loadInterupted=o,e.attach(this.containerId,this.currentVideo,this.isBackground,this.autoPlay).then((e=>{t.play=()=>{e.playVideo()},t.pause=()=>e.pauseVideo(),t.stop=()=>{e.pauseVideo()},window.addEventListener("message",(function(e){const{msg:i,stateParam:o}=e.data;"state"==i&&("play"===o?t.isPlaying=!0:"pause"!==o&&"stop"!==o||(t.isPlaying=!1))}),!1)})).finally((()=>i()))}))}initYoutube(){const t=this,e=new o,i={color:"#8F7247",controls:this.displayControls,disablekb:this.disabledKeyboard,fs:1};this.autoPlay,this.loop&&(i.loop=this.loop,i.controls=0,i.playlist=this.currentVideo),null!==this.ccPolicyLanguage&&Object.assign(i,{cc_load_policy:this.ccLoadPolicy||1,cc_lang_pref:this.ccPolicyLanguage}),this.controlsReady=new Promise(((o,n)=>{this.loadInterupted=n,e.attach(this.containerId,this.currentVideo,this.isBackground,this.autoPlay,i).then((e=>{t.play=()=>e.playVideo(),t.pause=()=>e.pauseVideo(),t.mute=()=>e.mute(),t.unMute=()=>e.unMute(),t.stop=()=>e.stopVideo(),t.moveTo=(t=0)=>this.player.seekTo(t,!0),e.addEventListener("onStateChange",(e=>{e.data===window.YT.PlayerState.PLAYING?t.isPlaying=!0:e.data!==window.YT.PlayerState.UNSTARTED&&e.data!==window.YT.PlayerState.ENDED&&e.data!==window.YT.PlayerState.PAUSED||(t.isPlaying=!1)}))})).finally((()=>o()))}))}initLocal(){const t=document.getElementById(this.containerId);this.play=()=>t.play(),this.pause=()=>t.pause()}renderVideo(){if("local"===this.videoService){const t=1===this.autoPlay?"true":"false",e=1===this.loop?"true":"false";return`\n                <video autoplay="${t}" muted="${this.mute}" loop="${e}" id="${this.containerId}">\n                    <source src="${this.currentVideo}" type="video/mp4">\n                </video>\n            `}return`<div id="${this.containerId}"></div>`}render(){this.innerHTML=`${this.renderVideo()}`}_externalControl(t){const e=(t=>{if(t.detail)return t.detail})(t),{action:i,time:o=null}=e;switch(i){case"play":this.play();break;case"pause":this.pause();break;case"mute":this.mute();break;case"unmute":this.unMute();break;case"stop":this.stop();break;case"moveTo":this.moveTo(o)}}unbindEvent(){""!==this.popinId&&(window.removeEventListener("WEB_COMPONENT_POPIN_CLOSED",this.boundOnPopinClosed),window.removeEventListener("WEB_COMPONENT_POPIN_OPENED",this.boundOnPopinOpened),window.removeEventListener("WEB_COMPONENT_VIDEO_TOGGLE",this.boundOnTogglePlayback)),""!==this.currentVideo&&window.removeEventListener("WEB_COMPONENT_VIDEO"+this.containerId,this.boundExternalControl),this.loadInterupted&&(this.loadInterupted(),this.loadInterupted=null)}disconnectedCallback(){this.unbindEvent()}}customElements.get("nb-video")||customElements.define("nb-video",h);export{h as default};
