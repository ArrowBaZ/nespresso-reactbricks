const e=e=>null==e;class s extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(e=null){const s=e||this.attributes;let t;try{t=[...s].reduce(((e,s)=>({...e,[s.nodeName]:s.nodeValue})),{});const e=[...s].find((e=>"data"===e.nodeName));return null==e?t:{...t,...JSON.parse(e.nodeValue)}}catch(e){console.log("ERROR: No data",e)}}render(e=!1){e&&(this.innerHTML="");const s=(e,t)=>{const i=e=>3===e.nodeType?"text":8===e.nodeType?"comment":e.tagName.toLowerCase(),n=e=>e.childNodes&&e.childNodes.length>0?null:e.textContent;var r=Array.prototype.slice.call(t.childNodes),o=Array.prototype.slice.call(e.childNodes),a=r.length-o.length;if(a>0)for(;a>0;a--)r[r.length-a].parentNode.removeChild(r[r.length-a]);o.forEach((function(e,o){if(r[o])if(i(e)===i(r[o])){var a=n(e);if(a&&a!==n(r[o])&&(r[o].textContent=a),r[o].childNodes.length>0&&e.childNodes.length<1)r[o].innerHTML="";else{if(r[o].childNodes.length<1&&e.childNodes.length>0){var l=document.createDocumentFragment();return s(e,l),void r[o].appendChild(l)}e.childNodes.length>0&&s(e,r[o])}}else r[o].parentNode.replaceChild(e.cloneNode(!0),r[o]);else t.appendChild(e.cloneNode(!0))}))},t=(i=this.template,(new DOMParser).parseFromString(i,"text/html").body);var i;s(t,this)}loadTemplate(e="",s=!1){this.template=""===e?this.template:`${e}`,this.render(s)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",s);const t={get is(){const{innerWidth:e,devicePixelRatio:s}=window;return{mobile:e<768,mobile_tablet:e<1024,tablet:e>=768&&e<1024,desktop:e>=1024&&s<=1,retina:e>=1024&&s>1}},lt:e=>window.innerWidth<e},i=e=>e.replace(/(<([^>]+)>)/gi,"");window.gtmDataObject=window.gtmDataObject||[];const n=(()=>{let e=null,s=0;const t=()=>{const t=e.getAttribute("sticky")||"false";let i=0,n=!1,r={};for(var o=0;o<e.parentElement.childNodes.length&&(e.parentElement.childNodes[o].tagName&&e.parentElement.childNodes[o].tagName===e.tagName&&(r=e.parentElement.childNodes[o+2],r&&(i=r.offsetTop-80,n=!0)),!n);o++);n&&0===i&&(i=e.parentElement.offsetTop+e.parentElement.offsetHeight);const a=window.scrollY-i>0;"true"===t!==a&&(e.setAttribute("sticky",a),s>0&&(document.body.style.paddingTop=a?s+"px":"0px"))},i=()=>{window.addEventListener("scroll",t)},n=()=>{window.removeEventListener("scroll",t)};return{initialize:(n,r=s)=>{e=n,s=r,e.setAttribute("sticky","false"),e.classList.add("nb-sticky-container"),t(),i()},destroy:()=>{n()},updatePosition:(s=0)=>{const t=document.querySelector(".Header__top")?.getBoundingClientRect()||{height:0,y:0},i=t.height,n=`${t.y+i+s}px`;return e.style.top=n,0}}})();class r extends HTMLElement{static get observedAttributes(){return["sticky"]}constructor(){super(),this.props={},this.currentCapsules=0,this.firstThresholdCapsules="0",this.firstThresholdCount="",this.secondThresholdCapsules="",this.boundExpand=this.expand.bind(this),this.boundCollapse=this.collapse.bind(this)}connectedCallback(){this.props=(s=>{const t=(e=>e.find((e=>"data"===e.nodeName)))([...s]),i=[...s].filter((e=>"data"!==e.nodeName)).reduce(((e,s)=>({...e,[s.nodeName]:s.nodeValue})),{});if(e(t))return i;try{return{...i,...JSON.parse(t.nodeValue)}}catch(e){console.log("ERROR: No data",e)}})(this.attributes);const{campaign:s}=this.props;var i;this.render(),!t.is.mobile&&this.stickyDesktop&&n.initialize(this),i={eventAction:"Promo Impression - On Load",ecommerce:{promoView:{promotions:[{...s}]}}},window.gtmDataObject.push({event:"impression",eventRaisedBy:"Web component",eventAction:"Promo Impression - On Scroll",ecommerce:{},...i}),this.isWindowNapiActive&&!this.standardBanner?this.readCart():console.warn("window.napi is not active ")}attributeChangedCallback(e,s,i){"sticky"===e&&this.props&&i!==s&&(this.props.sticky=i,!t.is.mobile&&this.stickyDesktop&&n.updatePosition())}render(){const{background_color:e,contrast:s}=this.props.layout,{standard_banner:i,offer_both_gifts:n,sticky_mobile:r,sticky_desktop:o}=this.props.options,{badge:a,first_threshold_capsules:l,second_threshold_capsules:d}=this.props.copywriting;this.style.backgroundColor=e,this.standardBanner=!0===i||"true"===i,this.offerBothGifts=!0===n||"true"===n,this.stickyMobile=!0===r||"true"===r,this.stickyDesktop=!0===o||"true"===o,this.setAttribute("standard_banner",this.standardBanner),this.setAttribute("offer_both_gifts",this.offerBothGifts),this.setAttribute("expanded_mobile","false"),this.setAttribute("contrast",s),this.firstThresholdCapsules=parseInt(l),this.secondThresholdCapsules=parseInt(d),this.firstThresholdCount=this.firstThresholdCapsules?this.percentage(this.firstThresholdCapsules):"",this.innerHTML=`\n            <aside\n                aria-label="${a}"\n                class="${t.is.mobile?"":"expanded"}"\n            >\n                ${this.standardBanner?"":this.renderButtons()}\n\n                ${a&&`<mark class="t-3xs-500-sl" aria-live="polite">${a}</mark>`}\n                <div class="cb-row">\n                    <div class="cb-col1">\n                        ${this.renderGiftImage()}\n                        ${this.renderHeadingDescription()}\n                        ${this.renderCtaPopin()}\n                    </div>\n                    ${this.standardBanner?"":this.renderCapsulesMeter()}\n                </div>\n            </aside>\n            ${this.renderPopin()}\n        `,t.is.mobile&&this.stickyMobile&&this.classList.add("bottom-fixed"),this.standardBanner||this.initButtons(),this.bindEvents()}initButtons(){t.is.mobile&&(this.expandBtn=this.querySelector(".expand"),this.collapseBtn=this.querySelector(".collapse"),this.collapseBtn.classList.add("hide"))}renderButtons(){const{label_expand:e,label_collapse:s}=this.props.copywriting;return t.is.mobile?`<nb-cta class="nav collapse" variation="navigation" contrast="dark" icon_right="close" size="32">${s}</nb-cta>\n                <nb-cta class="nav expand" variation="navigation" contrast="dark" icon_right="plus-16" size="32">${e}</nb-cta>`:""}renderGiftImage(){const{gifts_image:e,gifts_image_alt:s}=this.props.copywriting;return t.is.mobile||this.standardBanner?`<img loading="lazy" src="${e}" alt="${s}" />`:""}renderCapsulesMeter(){const{a11y_disclaimer_label:e,disclaimer_txt:s}=this.props.copywriting;return`\n            <div class="cb-col2">\n                <div class="bar">\n                    <div class="gifts">\n                        <span class="zero" aria-hidden="true"><p class="t-sm-400">0</p></span>\n                        <span aria-hidden="true" class="value" style="left:${this.percentage(this.currentCapsules)||2}%;">\n                            <p class="t-sm-700">${this.currentCapsules}</p>\n                        </span>\n                        ${this.firstThresholdCount&&this.renderFirstThreshold()}\n                        ${this.renderSecondThreshold()}\n                    </div>\n                    <progress\n                        id="progress-bar"\n                        role="progressbar"\n                        min="0"\n                        aria-valuemin="0"\n                        max="${this.secondThresholdCapsules}"\n                        aria-valuemax="${this.secondThresholdCapsules}"\n                        value="${this.currentCapsules}"\n                        aria-valuenow="${this.currentCapsules}"\n                        aria-label="${this.renderA11yCurrentCapsules()}">\n                    </progress>\n                    ${s?`<small class="disclaimer t-2xs-500" aria-live="polite" aria-atomic="false" aria-label="${e||""}"><sub aria-hidden="true">*</sub>${s}</small>`:""}\n                </div>\n            </div>\n        `}renderFirstThreshold(){const{first_threshold_image:e,first_threshold_image_alt:s}=this.props.copywriting;return`\n            <span class="first" style="left:${this.firstThresholdCount}%"\n                aria-label="${s}">\n                <sub aria-hidden="true">*</sub>\n                <img aria-hidden="true" loading="lazy" src=${e} alt="${s}" />\n                <p class="t-sm-700" aria-hidden="true">${this.firstThresholdCapsules}</p>\n                <p class="sr-only">${this.renderA11yFirstThresholdTotal()}</p>\n                <p class="sr-only">${this.renderA11yFirstThresholdDescription()}</p>\n            </span>\n        `}renderSecondThreshold(){const{second_threshold_image:e,second_threshold_image_alt:s}=this.props.copywriting;return`\n            <span class="end"\n                aria-label="${s}">\n                <img aria-hidden="true" loading="lazy" src=${e} alt="${s}" />\n                <p class="t-sm-700" aria-hidden="true">${this.secondThresholdCapsules}</p>\n                <p class="sr-only">${this.renderA11ySecondThresholdTotal()}</p>\n                <p class="sr-only">${this.renderA11ySecondThresholdDescription()}</p>\n            </span>\n        `}renderCtaPopin(){const{id:e,text:s}=this.props.copywriting.popin,{contrast:t}=this.props.layout;if(!s)return"";const{campaign:i}=this.props;return`<nb-link\n                    campaign_id="${i.id}"\n                    campaign_name="${i.name}"\n                    campaign_position="${i.position}"\n                    campaign_creative="${i.creative}"\n                    size="xsmall"\n                    color="${"light"===t?"black":"white"}"\n                    popin_id="${e}"\n               >${s}</nb-link>`}renderA11yCurrentCapsules(){const{a11y_current_capsules:e=""}=this.props.copywriting;return e.replace("{currentCapsules}",this.currentCapsules)}renderA11yFirstThresholdTotal(){const{a11y_common_threshold_description:e="",second_threshold_heading:s}=this.props.copywriting;return this.currentCapsules<this.firstThresholdCapsules?e.replace("{thresholdPlaceholder}",this.firstThresholdCapsules):this.currentCapsules<this.secondThresholdCapsules||this.offerBothGifts?s:""}renderA11yFirstThresholdDescription(){const{disclaimer_txt:e}=this.props.copywriting;return this.currentCapsules<this.firstThresholdCapsules?i(this.renderFirstThresholdDescription()):this.currentCapsules>=this.firstThresholdCapsules&&!this.offerBothGifts?e:""}renderA11ySecondThresholdTotal(){const{a11y_common_threshold_description:e=""}=this.props.copywriting;return this.currentCapsules<this.secondThresholdCapsules?e.replace("{thresholdPlaceholder}",this.secondThresholdCapsules):""}renderA11ySecondThresholdDescription(){const{success_heading:e}=this.props.copywriting;return this.currentCapsules<this.secondThresholdCapsules?i(this.renderSecondThresholdDescription()):this.currentCapsules>=this.secondThresholdCapsules?e:void 0}renderFirstThresholdDescription(){const{first_threshold_description:e=""}=this.props.copywriting;return e.replace("{countPlaceholder}",this.firstThresholdCapsules-this.currentCapsules)}renderSecondThresholdDescription(){const{second_threshold_description:e=""}=this.props.copywriting;return e.replace("{countPlaceholder}",this.secondThresholdCapsules-this.currentCapsules)}renderHeadingDescription(){let{heading:e,description:s,second_threshold_heading:i,success_heading:n,success_description:r}=this.props.copywriting;const o=!!this.firstThresholdCapsules;return this.setAttribute("step","0"),this.currentCapsules&&!this.standardBanner&&(o?(this.currentCapsules<this.firstThresholdCapsules&&(this.setAttribute("step","0-1"),s=this.renderFirstThresholdDescription()),this.currentCapsules===this.firstThresholdCapsules&&(this.setAttribute("step","1"),e=i,s=this.renderSecondThresholdDescription()),this.currentCapsules>this.firstThresholdCapsules&&this.currentCapsules<this.secondThresholdCapsules&&(this.setAttribute("step","1-2"),e=i,s=this.renderSecondThresholdDescription())):(this.setAttribute("step","0-2"),this.currentCapsules<this.secondThresholdCapsules&&(s=this.renderSecondThresholdDescription())),(this.currentCapsules===this.secondThresholdCapsules||this.currentCapsules>this.secondThresholdCapsules)&&(this.setAttribute("step","end"),e=n,s=r)),`\n            ${e?`<h3 class="${t.is.mobile?"t-2xs-700-sl":"t-md-700-caps-sl"}" aria-live="polite" aria-atomic="false">${e}</h3>`:""}\n            ${s?`<p class="${t.is.mobile?"t-2xs-500-sl":"t-xs-500-sl"}" aria-live="polite">${s}</p>`:""}\n        `}renderPopin(){const{id:e,image:s,heading:t,description:i,image_alt:n,close:r}=this.props.copywriting.popin;return e?`<nb-popin\n                    id="${e}"\n                    heading="${t}"\n                    variation="next"\n                    bgcolor="white"\n                    image="${s}"\n                    image_alt="${n}"\n                    label_close="${r}">\n                        <div class="wysiwyg t-sm-400">${i}</div>\n                </nb-popin>`:""}async readCart(){const e=this,s=await window.napi.cart().read();this.calculateTheCapsuleCount(s),window.napi.data().on("cart.update",(()=>{window.napi.cart().read().then((s=>{e.calculateTheCapsuleCount(s)})).catch((e=>console.error(e)))}))}calculateTheCapsuleCount(e){if(!e.length)return void this.barRerender(0);const{technology:s,exclude:t}=this.props.copywriting;let i=e.map((e=>e.productId.split("prod/").pop()));const n=t.trim();if(n){let e=n.split(",");if(i=i.filter((s=>-1===e.indexOf(s))),!i.length)return}Promise.all(i.map((e=>window.napi.catalog().getProduct(e)))).then((t=>{if(!t)return;const i=[].concat(t).filter((e=>"capsule"===e.type));if(!i.length)return void this.barRerender(0);let n=[];i.forEach((t=>{const i=e.filter((e=>e.productId===t.id)),r=t.bundled;if("both"!==s){const e=t.technologies.map((e=>e.split("/").pop()));if(-1===e.indexOf(s))return}r?n.push(i[0].quantity*t.unitQuantity):n.push(i[0].quantity)}));const r=n.reduce((function(e,s){return e+s}),0);this.barRerender(r)})).catch((()=>{throw new Error("getProduct fail on sku")}))}barRerender(e){this.currentCapsules=e,this.unbindEvents(),this.render()}isWindowNapiActive(){return!!window.napi}expand(e){e.preventDefault(),this.expandBtn.classList.add("hide"),this.collapseBtn.classList.remove("hide"),this.setAttribute("expanded_mobile","true")}collapse(e){e.preventDefault(),this.collapseBtn.classList.add("hide"),this.expandBtn.classList.remove("hide"),this.setAttribute("expanded_mobile","false")}percentage(e){return parseInt((e/this.secondThresholdCapsules*100).toFixed(3))}bindEvents(){this.expandBtn&&this.expandBtn.addEventListener("click",this.boundExpand),this.collapseBtn&&this.collapseBtn.addEventListener("click",this.boundCollapse)}unbindEvents(){this.expandBtn&&this.expandBtn.removeEventListener("click",this.boundExpand),this.collapseBtn&&this.collapseBtn.removeEventListener("click",this.boundCollapse)}disconnectedCallback(){this.unbindEvents(),!t.is.mobile&&this.stickyDesktop&&n.destroy()}}customElements.get("nb-dynamic-banner")||customElements.define("nb-dynamic-banner",r);export{r as default};
