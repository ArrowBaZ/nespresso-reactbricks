window.gtmDataObject=window.gtmDataObject||[];function t(t){const e=document.implementation.createHTMLDocument("");return e.body.innerHTML=t,e.body.childNodes}class e extends class{constructor(t,e){this.observer=new IntersectionObserver((t=>this.onChange(t)),{threshold:[0],rootMargin:"0% 0%"}),this.el=t,this.data=e,this.el instanceof Element&&this.observer.observe(this.el)}onChange(t){t.forEach((t=>{t.isIntersecting&&(this.track(t),this.observer.unobserve(t.target))}))}track(){window.requestIdleCallback((()=>this.runTrack()))}runTrack(){var t;this.data.id&&null!==this.data.id&&""!==this.data.id&&(t={ecommerce:{promoView:{promotions:[this.data]}}},window.gtmDataObject.push({event:"impression",eventRaisedBy:"Web component",eventAction:"Promo Impression - On Scroll",ecommerce:{},...t}))}}{constructor(t,e,i,n,s){super(t),this.data=e,this.currency=i,this.range=n,this.position=s}async runTrack(){if(!this.data)return;const t=await this.getCategories(this.data);window.impressionsOnScroll=window.impressionsOnScroll||{},window.impressionsOnScroll[this.data.internationalId]=this.buildGTMProductObject(this.data,t)}async getPLPCategory(t){return(await window.getPLPData()).data.configuration.eCommerceData.categories.find((e=>e.id===t))}async getCategoriesWithPlpData(t){const e="/machineTechno/",i=[...t.cupSizes,...t.flavors,...t.ranges,...t.technologies];return(await Promise.all(i.map((async t=>{const i=await this.getPLPCategory(t);return!i&&(t=>-1!==t.indexOf(e))(t)?(t=>t.substr(t.indexOf(e)+e.length))(t):i.name})))).join("|")}async getCategories(t){return t?window.getPLPData?this.getCategoriesWithPlpData(t):Promise.all(t.supercategories.map((t=>window.napi.catalog().getCategory(t)))).then((t=>{const e=[];for(const i of t){const t=i.code;if(!t)return;(~t.indexOf("-cupSize-")||~t.indexOf("-range-")||~t.indexOf("capsule-aromatic-")||~t.indexOf("machine-keyFeature-")||~t.indexOf("machine-color-")||~t.indexOf("accessory-collection-")||~t.indexOf("accessory-hero-month"))&&e.push(i.name.toLowerCase())}return e.join("|")})):""}buildGTMProductObject(e,i){let n;"capsule"===e.type?n="capsules":"accessory"===e.type?n="accessories":"machine"===e.type&&(n="machines");let s=null;e.technologies&&(s=e.technologies.map((t=>function(t=""){return t[0].toUpperCase()+t.slice(1)}(t.split("/")[2]))).join("|||"));let o="";null!=e.productSelections&&(o=e.productSelections.join("|"));const a={brand:"Nespresso",category:n,dimension43:"false",dimension44:"false",dimension53:e.legacyId,dimension54:t(e.name)[0].textContent,dimension55:i,dimension56:s,dimension57:this.isBundled(e)?"bundled":"single",dimension130:o,id:e.internationalId,name:t(e.internationalName)[0].textContent,price:e.price};return this.range&&(a.list=this.range),this.position&&(a.position=parseInt(this.position)),a}isBundled(t){let e=1===t.salesMultiple&&t.unitQuantity>1;return t.bundled?e=t.bundled:t.salesMultiple>1&&1===t.unitQuantity&&(e=!1),e}}class i extends HTMLElement{connectedCallback(){this.sku=(this.getAttribute("sku")||"").trim(),this.range=this.getAttribute("range"),this.position=this.getAttribute("position"),this.longSku=(this.getAttribute("longSku")||"").trim(),this.buttonSize=this.getAttribute("buttonSize")||"small",this.rendererName=this.getAttribute("rendererName")||"default",this.elementID=`u-product-${""!==this.range?this.range.replace(/(\s|\W)/g,"")+"-":""}${this.position}-${this.sku}-${this.longSku.replace(/(\s|\W)/g,"")}-${this.rendererName}`,this.render(),this.isWindowNapiActive()&&(window.napi.getConfig().then((()=>{this.pushButton()})).catch((t=>console.error(t))),this.tracking().then((()=>{})).catch((t=>console.error(t))))}render(){this.innerHTML=`<div class="cb-AddToCart" id="${this.elementID}">\n                <button class='AddToBagButtonLarge'>\n                    <span class='AddToBagButtonLarge__label'>+</span>\n                </button>\n            </div>`}isWindowNapiActive(){return!!window.napi}pushButton(){if(!document.getElementById(this.elementID))return;const t=this.buttonSize;window.ui=window.ui||[],window.ui.push({id:this.elementID,module:"AddToBagButton",configuration:{props:{productId:this.longSku,buttonSize:t}},ecommerceData:{activated:!0}})}async tracking(){if(!this.isWindowNapiActive())return new Promise.resolve;!function(t,i,n,s,o){const a=new e(t,i,n,s,o)}(this,await this.getProductData(),window[window.config.padl.namespace].dataLayer.app.app.currency,this.range,this.position)}getSkuKey(t){return-1!==t.indexOf("prod/")?"id":"legacyId"}async getProductData(){if(null!=window.getPLPData){const t=this.getSkuKey(this.sku),e=await window.getPLPData(),i=[t,"internationalId","id","legacyId"];let n=0,s=null;for(;!s&&n<i.length-1;){const t=i[n];s=e.data.configuration.eCommerceData.products.find((e=>e[t]===this.sku)),n++}return s}if(this.isWindowNapiActive())return await window.napi.catalog().getProduct(this.longSku);console.error("Error: napi is not found.")}}customElements.get("nb-add-to-cart")||customElements.define("nb-add-to-cart",i);export{i as default};
