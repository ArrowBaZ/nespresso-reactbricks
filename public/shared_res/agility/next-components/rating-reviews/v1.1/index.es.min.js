const e=e=>{const n=(e=>e.find((e=>"data"===e.nodeName)))([...e]),i=[...e].filter((e=>"data"!==e.nodeName)).reduce(((e,t)=>({...e,[t.nodeName]:t.nodeValue})),{});if(t(n))return i;try{return{...i,...JSON.parse(n.nodeValue)}}catch(e){console.log("ERROR: No data",e)}},t=e=>null==e,n=window.napi&&window.napi.ratings,i=async e=>{const t=`n-ratings-${e}`;let i=(e=>{const t=localStorage.getItem(e);if(!t)return;const n=JSON.parse(t);if(!((new Date).getTime()>n.expiry))return n.value;localStorage.removeItem(e)})(t);return void 0===i&&(i=await n().summary(e),((e,t)=>{const n={value:t,expiry:(new Date).getTime()+864e5};localStorage.setItem(e,JSON.stringify(n))})(t,i)),i},s=async(e,t="highlightedFirst",i=0)=>n().read(e,t,i);const r=e=>o(JSON.stringify(e)),o=e=>e?e.toString().replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"",a=()=>window[window?.padlNamespace]?.dataLayer,l=()=>{const e=a();return e?e.app.app.market.toLocaleLowerCase():"ch"},c=()=>a()?a().page.page.pageInfo.language.toLocaleLowerCase():"en",d=()=>{const e=a();return!(!e||!e.user)&&e.user.isLoggedIn};class h extends HTMLElement{constructor(){super(),this.template=""}connectedCallback(){this.props=this._createProps(),this.onStart?.(),this.loadTemplate(),this.onReady?.()}_createProps(e=null){const t=e||this.attributes;let n;try{n=[...t].reduce(((e,t)=>({...e,[t.nodeName]:t.nodeValue})),{});const e=[...t].find((e=>"data"===e.nodeName));return null==e?n:{...n,...JSON.parse(e.nodeValue)}}catch(e){console.log("ERROR: No data",e)}}render(e=!1){e&&(this.innerHTML="");const t=(e,n)=>{const i=e=>3===e.nodeType?"text":8===e.nodeType?"comment":e.tagName.toLowerCase(),s=e=>e.childNodes&&e.childNodes.length>0?null:e.textContent;var r=Array.prototype.slice.call(n.childNodes),o=Array.prototype.slice.call(e.childNodes),a=r.length-o.length;if(a>0)for(;a>0;a--)r[r.length-a].parentNode.removeChild(r[r.length-a]);o.forEach((function(e,o){if(r[o])if(i(e)===i(r[o])){var a=s(e);if(a&&a!==s(r[o])&&(r[o].textContent=a),r[o].childNodes.length>0&&e.childNodes.length<1)r[o].innerHTML="";else{if(r[o].childNodes.length<1&&e.childNodes.length>0){var l=document.createDocumentFragment();return t(e,l),void r[o].appendChild(l)}e.childNodes.length>0&&t(e,r[o])}}else r[o].parentNode.replaceChild(e.cloneNode(!0),r[o]);else n.appendChild(e.cloneNode(!0))}))},n=(i=this.template,(new DOMParser).parseFromString(i,"text/html").body);var i;t(n,this)}loadTemplate(e="",t=!1){this.template=""===e?this.template:`${e}`,this.render(t)}disconnectedCallback(){this.onDestroy?.()}}customElements.get("nb-nespresso-element")||customElements.define("nb-nespresso-element",h),window.gtmDataObject=window.gtmDataObject||[];const p=e=>{window.gtmDataObject.push({event:"customEvent",eventRaisedBy:"Web component",eventCategory:"User Engagement",eventAction:"Click",eventLabel:"",nonInteraction:0,...e})},u="rating-and-reviews-popin-id";class v extends HTMLElement{constructor(){super(),this.props={},this.reviewResult=[],this.sort="highlightedFirst",this.pageIndex=0,this.boundOnSeeMore=this.onSeeMore.bind(this),this.boundOnLike=this.onLike.bind(this),this.boundOpenPopin=this.onOpenPopin.bind(this),this.boundOnSortBy=this.onSortBy.bind(this),this.seeMoreBtn=null,this.sortByBtn=null,this.encodedProductId=null}connectedCallback(){this.props=e(this.attributes),this.render()}render(){this.innerHTML=`\n            ${this.renderIntroduction()}\n            <div class="cb-all is-loading">\n                <nb-loader></nb-loader>\n            </div>\n        `,this.allElement=this.querySelector(".cb-all"),this.loadReviews().then().catch((e=>{console.error("Error: Component Review List - loadReviews"),console.error(e),this.querySelector(".cb-all").innerHTML=""})).finally((()=>{this.prepareFormSubmit()}))}prepareFormSubmit(){this.formElement=this.querySelector("nb-form"),this.formElement.submitValidForm=async function(e){const t=new URLSearchParams;for(const n of e.formData)t.append(n[0],n[1]);fetch(this.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:t}).then((e=>{const{status:t}=e;t<400?(this.onSuccess(),p({eventAction:"Rating and Reviews - Submit Review",eventLabel:`R&R Product: ${this.props.product_name}`})):e.json().then((e=>{console.error("Error: Component Review List - Submit Review"),console.error(e);const{message:t=""}=e;this.onError(t)}))}))}.bind(this.formElement),this.formElement.url=`/ecapi/rating/v1/${l()}/${c()}/${this.encodedProductId}/submit`}renderIntroduction(){const{reviews_panel:{heading:e,msg_to_review:t}={}}=this.props;return`<div class="cb-intro">\n            <h3 class="t-md-700-caps">${e}</h3>\n            <p class="wysiwyg t-sm-400">${t}</p>\n            ${this.renderCtaWriteReview()}\n            ${this.renderModalReview()}\n        </div>`}renderCtaWriteReview(){const{reviews_panel:{cta:e}={}}=this.props,{label:t}=e;if(!t)return"";if(!d()){const t=(window.location.search?"%26":"%3F")+"shouldOpenReview=true";e.link=`/${l()}/${c()}/secure/login?destination-redirect=${window.location.pathname}${window.location.search}${t}`}return`<nb-cta data="${r(e)}">${t}</nb-cta>`}renderModalReview(){const{rating_submit:e}=this.props;return`<nb-popin\n                    id="${u}"\n                    popin_id="${u}"\n                    size="M"\n                    variation="before"\n                    bgcolor="white"\n                    label_close="${e.a11y_label_popin_close}"\n                    heading="${e.heading}">\n                    <nb-form data="${r(e)}"></nb-form>\n                </nb-popin>`}reviewAllLoaded(){this.allElement.innerHTML="",this.allElement.classList.remove("is-loading")}async loadReviews(){const{product_id:e,sku:t}=this.props;var n;this.encodedProductId=(n=e,window.btoa(n));if(!(e=>e.reviewCount>0)(await i(t)))return this.reviewAllLoaded(),"";this.reviewResult=await s(t),this.renderListHeader(),this.bindEvent()}renderListHeader(){this.unbindEvent();const{reviews_panel:e}=this.props;this.reviewAllLoaded();const t=this.renderSortBy(this.reviewResult);let n="";this.reviewResult.pageIndex<this.reviewResult.pageCount-1&&(n=this.renderSeeAllReviews()),this.allElement.innerHTML=`\n            <div class="cb-sort-bar">\n                <h3 class="t-md-700-caps">${e.label_all_reviews}</h3>\n                <nb-dropdown data="${r(t)}"></nb-dropdown>\n            </div>\n            <div class="cb-details">\n                <nb-loader></nb-loader>\n            </div>\n            ${n}\n        `,this.renderList(),this.bindEvent();"true"===new URLSearchParams(window.location.search).get("shouldOpenReview")&&("true"!==sessionStorage.getItem("reviewPopUpOpened")&&this.writeReviewBtn.click(),sessionStorage.setItem("reviewPopUpOpened","true"))}renderSortBy(){const{reviews_panel:e}=this.props,t=this.reviewResult.availableSortCriteria,n=this.reviewResult.sortCriteria,i=t.map((t=>({label:e[`dropdown_${t}_option_label`],checked:t===n,value:t})));return{...e.sort_dropdown,options:i}}renderList(){document.querySelector(".cb-details").innerHTML=this.reviewResult.reviews.map((e=>this.renderReview(e))).join("")}renderReview(e){const{reviews_panel:t}=this.props,{date:n,rating:i,author:s,title:r,content:o}=e,{a11y_label_author_by:a}=t,l=new Date(n).toLocaleDateString("en-GB");return`<article>\n                    <header>\n                        <nb-rating stars="${i}" hide_star_number="true"></nb-rating>\n                        <time datetime="${l}" class="t-sm-400">${a} ${s} - ${l}</time>\n                    </header>\n                    <h4 class="t-xs-700-caps">${r}</h4>\n                    <p class="t-sm-400">${o}</p>\n                    <footer>\n                        ${this.renderReviewHelpfulMsg(e)}\n                    </footer>\n                    ${this.renderReplies(e)}\n                </article>`}renderReviewHelpfulMsg(e){const{reviews_panel:{msg_review_helpful:t}}=this.props,{recommendationCount:n=0}=e;if(!t)return"";const i=n>-1?`<span class="t-xs-500">${n}</span>`:"";return`\n        <p class="t-xs-500">${t}</p>\n        <button class="js-like">\n            <nb-icon icon="upvote" data-reviewid="${e.id}"></nb-icon>\n            ${i}\n        </button>\n        `}renderReplies(e){const{replies:t}=e;return t&&t.length?`<aside>${t.map((e=>this.renderReply(e))).join("")}</aside>`:""}renderReply(e){const{author:t,title:n,content:i}=e;return i?`<div class='cb-reply'>\n                    <h5 class="t-sm-400-sl">\n                        <nb-icon icon="nespresso"></nb-icon>\n                        <span class="t-sm-400-sl">${t} - ${n}</span>\n                    </h5>\n                    <p class="t-sm-400">${i}</p>\n                </div>`:""}async onSeeMore(){const{product_name:e,sku:t}=this.props,n=window.scrollY;document.querySelector(".cb-details").innerHTML="<nb-loader></nb-loader>";const i=this.reviewResult.reviews;let r;this.pageIndex++,p({eventAction:"Rating and Reviews - See More Reviews",eventLabel:`R&R Product: ${e}`});try{r=await s(t,this.sort,this.pageIndex)}catch(e){return console.error(`Error: Component Review List - onSeeMore - ${e}`),void this.renderListHeader()}this.reviewResult={...r,reviews:[...i,...r.reviews]},this.renderListHeader(),window.scrollTo(0,n)}async onSortBy(e){const{sku:t}=this.props,n=document.querySelector(".cb-details");if(!n)return;let i;n.innerHTML="<nb-loader></nb-loader>",this.sort=e.detail.selected.value,this.pageIndex=0;try{i=await s(t,this.sort,this.pageIndex)}catch(e){return console.error(`Error: Component Review List - onSeeMore - ${e}`),void this.renderListHeader()}this.reviewResult=i,this.renderListHeader()}async onLike(e){const t=e.target.closest("nb-icon");if(!t)return;const i=t.dataset.reviewid,{sku:s}=this.props;if(!i)return void console.error("Error: Review ID not available - onLike");const r=await(async(e,t)=>n().like(e,t))(s,i);r&&r.numberOfLikes&&(t.nextElementSibling.innerHTML=r.numberOfLikes)}renderSeeAllReviews(){const{reviews_panel:e}=this.props,{label_see_more:t}=e;if(!t)return"";return`<nb-link data="${r({size:"large",color:"gold",link:"",campaign_id:"",campaign_name:"",campaign_creative:"",campaign_position:""})}">${t}</nb-link>`}onOpenPopin(){const{product_name:e}=this.props;p({eventAction:"Rating and Reviews - Write Review",eventLabel:`R&R Product: ${e}`}),d()&&(({eventName:e,args:t,element:n})=>{let i;n=n||window,t?i=new CustomEvent(e,{detail:t,bubbles:!0}):"function"==typeof Event?i=new Event(e):(i=document.createEvent("Event"),i.initEvent(e,!0,!0)),n.dispatchEvent(i)})({eventName:"WEB_COMPONENT_POPIN_OPEN",args:{id:u}})}bindEvent(){this.writeReviewBtn=this.querySelector(".cb-intro nb-cta"),this.seeMoreBtn=document.querySelector("nb-link"),this.likesBtn=document.querySelectorAll(".js-like"),this.sortByBtn=this.querySelector("nb-dropdown"),this.writeReviewBtn&&this.writeReviewBtn.addEventListener("click",this.boundOpenPopin),this.seeMoreBtn&&this.seeMoreBtn.addEventListener("click",this.boundOnSeeMore,{once:!0}),this.likesBtn&&this.likesBtn.forEach((e=>{e.addEventListener("click",this.boundOnLike,{once:!0})})),this.sortByBtn&&this.sortByBtn.addEventListener("WEB_COMPONENT_SORT_BY_CHANGE",this.boundOnSortBy)}unbindEvent(){this.writeReviewBtn&&this.writeReviewBtn.removeEventListener("click",this.boundOpenPopin),this.seeMoreBtn&&this.seeMoreBtn.removeEventListener("click",this.boundOnSeeMore),this.likesBtn&&this.likesBtn.forEach((e=>{e.removeEventListener("click",this.boundOnLike)})),this.sortByBtn&&this.sortByBtn.removeEventListener("click",this.boundOnSortBy)}disconnectedCallback(){this.unbindEvent()}}customElements.get("nb-reviews-list")||customElements.define("nb-reviews-list",v);const m=({msg_no_rating:e,msg_be_first_to_rate:t})=>`\n    <nb-rating stars="0"  hide_star_number="true"></nb-rating>\n    <p class="t-sm-400">${e}</p>\n    <p class="t-sm-700">${t}</p>\n`,b=async(e,t)=>{const{heading:n,rating_review_label:i="",a11y_label_average:s}=e;return`<h3 class="t-md-700-caps">${n}</h3>\n            <div class="cb-average">\n                <p class="h-3xl-700-sl">${Math.round(10*t.ratingAverage)/10} <span class='sr-only'>${s}</span></p>\n                <div class='cb-star-container'>\n                    <nb-rating stars="${t.ratingAverage}" hide_star_number="true"></nb-rating>\n                    <p class="cb-number t-xs-500">(${t.reviewCount} ${i})</p>\n                </div>\n            </div>\n            ${w(e,(e=>{const t=e.reduce(((e,t)=>e+t),0);return e.map((e=>e/t*100))})(t.ratingSpread))}\n            ${g(e,t)}\n            `},g=(e,{recommendationRateInPercent:t})=>{const{recommend_label:n}=e,i=t||0;if(!i)return"";return`<p class="cb-recommend t-sm-400-sl">${function(e,t,n,i){let s=0;for(;e;){const r=e.indexOf(n,s);if(-1===r)break;const o=e.indexOf(i,r+1);if(-1===o)break;const a=e.substring(r+n.length,o);null!=t[a]?(e=e.substr(0,r)+t[a]+e.substr(o+i.length),s=r):s=o}return e}(n,{recommended_percentage:i},"{","}")}</p>`},w=(e,t)=>{const{a11y_label_star:n}=e;return t&&t.length?t.reverse().map(((e,i)=>y(t.length-i,e,n))).join(""):""},y=(e,t,n)=>`\n        <div class="cb-rating-bar">\n            <p class="cb-stars t-xs-700">${e} <span class="sr-only">${n}</span></p>\n            <nb-icon icon="star"></nb-icon>\n            <div aria-hidden='true'><span style="width: ${t}%"></span></div>\n            <p class="cb-percent t-sm-400-sl">${Math.round(t)}%</p>\n        </div>`,_=e=>e?e.toString().replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class R extends HTMLElement{constructor(){super(),this.product={}}connectedCallback(){this.props=e(this.attributes),this.render()}render(){const{id:e,name:t,creative:n,position:i}=this.props.campaign;this.className="nb-rr",this.innerHTML=`\n            <nb-container\n                campaign_id="${e}"\n                campaign_name="${t}"\n                campaign_creative="${n}"\n                campaign_position="${i}"\n                classname="pt9 pb9"\n                contrast="light"\n                background_color="highlight_040">\n                ${this.renderHeading()}\n                <div class="cb-rating"><nb-loader></nb-loader></div>\n                <div class="cb-reviews"><nb-loader></nb-loader></div>\n            </nb-container>\n          `,this.checkRatingReviewsAvailability().then()}renderHeading(){const{heading:e}=this.props.copywriting;return e?`<h2 class="h-2xl-300-sl">${e}</h2>`:""}async checkRatingReviewsAvailability(){const{sku:e,reviews_panel:t,rating_submit:n}=this.props.copywriting,s=await(e=>window.napi.catalog().getProduct(e))(e);await(async(e,{rating_summary:t},n)=>{let s=m(t);if((e=>e.productRatings&&e.productRatings.ratingEnabled)(e)){const n=await i(e.legacyId);o=0,(r=n).reviewCount>0&&r.ratingAverage>0&&r.ratingAverage>=o&&(s=await b(t,n))}var r,o;n.innerHTML=s})(s,this.props.copywriting,this.querySelector(".cb-rating"));const r={product_id:s.id,product_name:s.internationalName,sku:e,reviews_panel:t,rating_submit:n};var o;this.querySelector(".cb-reviews").innerHTML=`\n            <nb-reviews-list data="${o=r,_(JSON.stringify(o))}"></nb-reviews-list>`}}customElements.get("nb-rating-reviews")||customElements.define("nb-rating-reviews",R);export{R as default};
